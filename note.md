# Node.js

- 백엔드 개발자가 사용하는 언어
- 서버에서 실행되는 자바스크립트입니다.
- Google V8 javaScript 엔진을 사용하여 코드를 실행하고 기본 모듈이 자바스크립트에 사용됩니다.
- node.js 에는 웹 서버프로그램 (apache,iis 등)같은  
  소프트웨어가 필요없이 웹 서버 역할을 할 수 있도록 하는 내장 라이브러리가 있습니다.
- NPM이라는 패키지 관리자가 포함되어 있습니다.  
  NPM은 node.js의 프로그램을 설치하는데 사용됩니다.

## NodeJs 기본 내장 모듈

### FileSystem

파일처리와 관련된 모듈입니다. 메소드가 많고 node.js에서 가장 중요하고 기초가 되는 모듈입니다.

메소드

- readfile() : 파일을 `비동기적`으로 읽습니다.
- readFileSync() : 파일을 `동기적`으로 읽습니다.
- writeFile() : 파일을 `비동기적`으로 씁니다.
- writeFileSync() : 파일을 `동기적`으로 씁니다.

> 동기와 비동기  
> 프로그램이 동작하는 상태에서 완전히 해당 내용을 끝내고 다음으로 제어를 넘기는 방식을 `동기`,  
> 동작이 끝나지 않은 상태에서도 제어권을 넘긴 후 프로그램을 계속 진행하면 `비동기식`이라고 합니다.

## 2020-04-26 예외 처리

프로그램이 실행되고 있는 런타임시에 에러가 발생할 경우 처리할 수 있는 프로그램의 구간

```javascript
try {
  // 예외상황이 발생할 수 있는 구간
} catch (e) {
  // 예외상황이 발생하였을 경우 처리되는 구간
} finally {
  // 예외상황이 발생하던 발생하지 않아도 처리되는 구간 (생략 가능)
}
```

## 이벤트 루프 (Event Loop)

Node.js 에서는 많은 이벤트를 빠르게 처리할 수 있습니다.  
Node.js 기반으로 만들어진 서버가 가동되면 변수들을 초기화하고 함수를 선언하고  
이벤트가 발생할 때까지 기다립니다.  
이벤트가 감지되었을 때 call back 함수를 호출합니다.

### 옵저버

이벤트를 대기하는 함수들이 옵저버 역할을 합니다.  
옵저버들이 이벤트들을 기다리다가 이벤트가 발생하면 이벤트를 처리하는 함수가 실행됩니다.

### events

이벤트 위주의 프로그램을 작성할 때 사용하는 모듈입니다.

### 메소드

eventEmitter.on() : 지정한 이벤트의 리스너를 추가합니다.  
eventEmitter.once() : 지정한 이벤트의 리스너를 추가하지만 한 번 실행된 후에 자동으로 제거됩니다.  
eventEmitter.removelistener() : 지정한 이벤트에 대한 리스너를 제거합니다.

## 시스템 이벤트 생성

process 객체는 노드에서 항상 사용할 수 있는 객체입니다.  
on()과 emit() 메소드를 바로 사용할 수 있습니다.  
process 객체의 on() 메소드를 호출하면서 이벤트 이름을 exit 로 지정하면,  
내부적으로 프로세스가 끝날 때를 알 수 있습니다.

```javascript
process.on("exit", function () {
  console.log("exit 이벤트 발생");
});

process.exit(); // 프로그램 종료
```

## http 모듈

Node.js 에서 가장 기본적이고 중요한 서버 객체입니다.  
http 모듈의 createServer() 메소드를 사용하여 server 객체를 생성합니다.

1.  **server 객체**

    ### 메소드

    listen() : 서버를 실행하고 클라이언트를 기다립니다.
    close() : 서버를 종료합니다.

    ### 이벤트

    requset : 클라이언트가 서버에 요청할 때 발생하는 이벤트입니다.
    connection : 클라이언트가 접속할 때 발생하는 이벤트입니다.
    close : 서버가 종료될 때 발생하는 이벤트입니다.

2.  **response 객체** : 서버에서 클라이언트로 응답 메세지를 전송시켜주는 객체

    ### 메소드

    writeHead() : 응답 헤더를 작성합니다.
    end() : 응답 본문을 작성합니다.

    ### MIME 형식

    text/plain : 일반적인 text 파일  
    text/html : html  
    text/css : css  
    text/xml : xml 형식 파일  
    image/jpeg : ...  
    ...

3.  **request 객체** : 클라이언트가 서버에게 전달하는 메세지를 담는 객체

    ### 속성

    method : 클라이언트 요청 방식을 나타냅니다.  
    url : 클라이언트가 요청한 URL을 나타냅니다.  
    headers : 요청 메세지 헤더를 나타냅니다.

    `http://www.asd.com/membermember`  
    <-------url------><--pathname-->  
    req.url : "http://www.asd.com/membermeber"  
    url.parse("http://www.asd.com/membermeber") -> url 형태의 분석  
    url.parse("http://www.asd.com/membermeber").pathname // member

## 익스프레스 웹 서버

http 모듈만 사용해서 웹 서버를 구성하면 많은 기능을 직접 개발해야 합니다.  
이 문제를 해결하기 위해 만들어진 모듈이 익스프레스입니다.  
express 모듈을 사용하면 간단한 코드로 웹 서버의 기능을 구현할 수 있으며,  
미들웨어와 라우터를 사용하여 편리하게 웹 서버를 구성할 수 있습니다.

### 메소드

- set()
  서버 설정을 위한 속성을 지정합니다.  
  set() 메소드로 지정한 속성은 get() 메소드로 꺼내어 확인할 수 있습니다.
- get()
  서버 설정을 위해 지정한 속성을 꺼내 옵니다.
- use()
  미들웨어 함수를 사용합니다.

### 속성 이름

- env
  서버 모드를 설정합니다.
- views
  뷰들이 들어 있는 폴더 또는 폴더 배열을 설정합니다.
- view engine
  디폴트로 사용할 뷰 엔진을 설정합니다.

### 익스프레스의 요청 객체와 응답 객체의 메소드

- redirect
  웹 페이지 경로를 강제로 이동시킵니다.
- send()
  클라이언트에 응답 데이터를 보냅니다.  
  보낼 수 있는 데이터는 HTML / Buffer 객체, JSON 객체, 등등
- status()
  HTTP 상태 코드를 반환합니다.  
  상태 코드는 end()나 send() 같은 전송 메소드를 추가로 호출해야 전송할 수 있습니다.
- sendStatus()
  HTPP 상태 코드를 반환합니다.  
  상태 코드는 상태 메세지와 함께 전송됩니다.
- render()
  뷰 엔진을 사용해 문서를 만든 후 전송합니다.

### 익스프레스 요청 객체에 추가된 헤더와 파라미터

- query
  클라이언트에서 GET 방식으로 전송한 요청 파라미터를 확인합니다.
- body
  클라이언트에서 POST 방식으로 전송한 요청 파라미터를 확인합니다.  
  단, body-parser 와 같은 모듈을 사용해야 합니다.
- header()
  헤더를 확인합니다.

### static 미들웨어

특정 폴더의 파일들을 특정 패스로 접근할 수 있도록 만들어 줍니다.  
예를 들어 public 폴더에 있는 모든 파일을 웹서버의 루트 패스로 접근할 수 있도록  
만들어 줄 수 있습니다.

serve-static 이라는 모듈 사용

### Router 미들웨어

사용자의 다양한 요청이 들어왔을 때 use() 메소드로 설정한 미들웨어가 항상 호출되는  
불편함이 있기 때문에 그 불편함을 해결하고자 사용하는 미들웨어입니다.

Router 객체 만들기

```js
var router = express.Router();

router.route(요청패스).get(실행할 함수)
router.route(요청패스).post(실행할 함수)
```

### Router 객체 메소드

- get()
  GET 방식으로 요청했을 때 사용할 콜백함수를 지정합니다.
- post()
  POST 방식으로 요청했을 때 사용할 콜백함수를 지정합니다.
- put()
  put 방식으로 요청했을 때 사용할 콜백함수를 지정합니다.
- delete()
  delete 방식으로 요청했을 때 사용할 콜백함수를 지정합니다.
- all()
  모든 요청 방식을 처리하며, 특정 패스 요청이 발생했을 때 사용할 콜백 함수를 지정합니다.

## EJS(Embeded JavaScript)

EJS 모듈은 템플릿 엔진 모듈입니다.  
템플릿 엔진 모듈은 특정한 형식인 파일로 부터 HTML 페이지를 생성하는 모듈을 의미합니다.

### EJS 파일 형식의 특수 태그

<% code %> : 자바스크립트 코드를 입력하는 영역을 의미합니다.
<%= 값 %> : 데이터를 출력합니다.

### EJS 데이터를 전달

render() : 메소드의 두번째 매개 변수에 전달하고자 하는 데이터를 입력하여 전달합니다.

## express-error-handler

특정 오류 코드에 따라 클라이언트로 응답을 보내 줄 때 미리 만들어 놓은 문서를 보내 줄 수 있습니다.

## 쿠키

클라리언트 웹 브라우저에 저장되는 정보로서 일정 기간 동안 저장하고 싶을 때 사용합니다.  
익스프레스에서는 cookie-parser 미들웨어를 사용하면 쿠키를 설정하거나 확인할 수 있습니다.  
req.cookie("변수명","값")

## 세션

세션은 쿠키와 동일하게 상태 정보를 저장하는 역할을 하지만, 쿠키와 달리 세션은 서버에 저장합니다.  
express-session 이라는 모듈을 사용  
cookie-parser 또한 사용

expressSession({
secret : 암호화 코드,
resave : 항상 세션을 저장할지 여부,
saveUninstialized : 세션 초기화 여부
})

## 파일 업로드

파일을 업로드할 때는 멀티파트 포멧으로 된 파일 업로드 기능을 사용하여 파일 업로드 상태등을 확인할 수 있습니다.  
멀티 파트 포멧은 음악이나 이미지 파일 등을 일반 데이터와 함께  
웹 서버로 보내려고 만든 표준 포멧입니다.  
따라서 일반적으로 웹 서버에서 파일을 업로드할 때는 멀티파트 포멧을 사용합니다.  
이를 구현하기 위해 익스프레스에서는 multer 미들웨어를 사용합니다.

npm install multer -- save

## Nodejs 에서의 databases -> MongoDB

### NoSQL

Not Only SQL 의 약자입니다. 기존의 RDBMS의 한계를 극복하기 위해 만들어진 새로운 형태의 데이터베이스입니다.  
관계형 DB가 아니므로 RDBMS처럼 고정된 스키마 및 JOIN이 존재하지 않습니다.

### NoSQL을 사용하는 이유

대부분의 이유는 성능 때문입니다. 관계형 데이터베이스는 시스템의 신뢰도를 높이는 장치를 많이 가지고 있습니다.  
SQL문을 읽어 들이고 실행하는 데 많은 리소스를 사용하기 때문에 성능이 많이 떨어지는 경우가 많습니다.  
이에 반해 NoSQL은 성능을 최우선으로 생각하며 신시간으로 처리해야하는 경우나 대용량 트래픽을 감당할 수 있는 메시징 시스템에 활용합니다.

### MongoDB

C++ 로 작성된 오픈소스문서지향적 데이터베이스이며, 뛰어난 확장성과 성능을 자랑합니다.  
또한 현존하는 NoSQL 데이터베이스 중 가장 많은 사용률을 기록하고 있습니다.

### MongoDB 특징

- NoSQL이기 때문에 RDBMS의 테이블 개념이 없습니다.
- 데이터가 모인 하나의 단위를 컬렉션이라고 부릅니다.
- 데이터를 정해 놓은 컬럼의 형태로 컬렉션에 넣어야 한다는 제약이 없습니다.
- 몽고디비의 데이터베이스는 컬렉션의 집합이라고 할 수 있습니다.
- 컬렉션은 여러 개의 문서 객체를 가질 수 있습니다.  
  문서 객체는 속성들의 집합으로 사람의 나이 등을 저장하고 있는 하나의 문서 객체를 만든 후  
  그 안에 JS객체와 같이 속성들을 추가하여  
  저장할 수 있습니다.
- \*객체(문서) -> 컬렉션 -> 데이터베이스

### 몽고디비 실행

- 환경변수 등록
  -> 시스템 -> 고급 시스템 설정 -> 환경변수 -> 시스템변수 -> path 편집 -> 파일 경로 추가
- 명령프롬프트 창을 관리자 권한으로 실행 후 명령어 입력
  `mongo`

### Collection

MongoDB의 Document의 그룹입니다. Collection 내부에 Document 들이 위치하고 있습니다.  
RDBMS의 table과 비슷한 개념이지만 RDBMS와 달리 스키마를 따로 가지지 않습니다.  
Document 들이 동적인 스키마를 가지고 있기 때문입니다.

### Document

RDBMS의 record와 비슷한 개념입니다. 데이터 구조는 한 개 이상의 key-value-pair로 이루어져 있습니다.  
Document는 동적인 스키마를 가지고 있습니다.  
같은 collection 안에 있는 document끼리 다른 스키마를 가지고 있을 수 있습니다.

#### 데이터베이스 생성 및 사용

> use 데이터베이스 명

MongoDB는 없는 애를 사용하겠다고 하면 만들어준다.

#### 데이터베이스 확인

> show dbs

- 데이터 베이스의 자료가 없을 경우 나타나지 않습니다.

#### 컬렉션 생성

> db.createCollection("컬렉션명")

#### 컬렉션 확인

> show collections

#### 컬렉션 삭제

> db.컬렉션이름.drop()

#### Document를 컬렉션에 추가

> db.컬렉션이름.insert({객체형태})

#### Document 확인 (조회)

> db.컬렉션이름.find() // 한줄 조회
> db.컬렉션이름.find().pretty() // 들여쓰기 및 객체 형태로 조회
> db.컬렉션이름.find({"찾는 속성" : "찾는 값"}).pretty()

#### Document 비교

1. \$eq : (equals) 주어진 값과 일치하는 값을 찾아줌
2. \$gt : (greater than) 주어진 값보다 큰 값
3. \$gte : (greater than or equals) 주어진 값보다 크거나 같은 값
4. \$lt : (less than) 주어진 값보다 작은 값
5. \$lte : (less than or equals) 주어진 값보다 작거나 같은 값
6. \$ne : (not equals) 주어진 값과 일치하지 않는 값
7. \$in : 주어진 배열 안에 속하는 값
8. \$nin : 주어진 배열 안에 속하지 않는 값

```js
// age 가 25살 보다 적은 데이터 반환
db.member.find({ age: { $lt: "25" } }).pretty();

// age 가 25살 보다 크거나 같은 데이터 반환
db.member.find({ age: { $gte: "25" } }).pretty();

// age 가 25살이랑 22 살인 애들 반환
db.member.find({ age: { $ln: ["22", "25"] } }).pretty();
```

#### Document 논리 연산

1. \$or : 주어진 조건 중 하나라도 true 일 때 true
2. \$and : 주어진 모든 조건이 true 일 때 true
3. \$not : 주어진 조건의 반댓 값
4. \$nor : 주어진 모든 조건이 false 일때 true

```js
// 남자 & (age > 28)
db.member.find({
   $and: [
     { "gender" : "남자" }, { "age": { $gt : "28"}
     ]
   }).pretty()
```

#### Document sort()

> db.컬렉션명.find().sort({key : value})
> value의 값은 -1 또는 1 => -1 내림차순 / 1 오름차순  
> 여러 key 값을 받을 수 있으며 먼저 입력한 key 가 우선권을 갖는다.

#### limit(갯수의 제한)

출력할 데이터 갯수를 제한할 때 사용합니다.

> db.member.find().limit(3)

#### skip(데이터 생략할 갯수)

출력할 데이터의 시작부분을 설정할 경우 사용됩니다.  
원하는 데이터를 생략하고 그 다음부터 출력합니다.

> db.member.find().skip(n)

이를 응용해서 한 페이지당 보여줄 데이터 갯수를 지정해 최신순으로 보여줄 수 있습니다.

```js
// 함수 선언이 가능하다
var showPage = function (page) {
  return db.member
    .find()
    .sort({ _id: -1 })
    .skip((page - 1) * 2)
    .limit(2);
};

showPage(1).pretty();
```

#### 특정 필드 update

> db.컬렉션명.update(기존객체형태,변경할객체형태)  
> 변경할객체형태 : {\$set : {객체}}

예시

```js
db.member.update({ userid: "apple" }, { $set: { name: "apple3" } });
```

#### 특정 필드 delete

> db.컬렉션명.remove(객체)

예시

```js
db.member.remove({ userid: "apple" });
```
